name: PR Review with Comments

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        id: claude_review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            Please perform a thorough code review focusing on:

            🔒 **Security Issues**:
            - SQL injection vulnerabilities
            - XSS vulnerabilities
            - Exposed API keys or credentials
            - Insecure data handling
            - CORS and authentication issues

            🐛 **Potential Bugs**:
            - Null/undefined handling
            - Type mismatches
            - Logic errors
            - Edge cases

            📊 **Code Quality**:
            - Code clarity and readability
            - Maintainability
            - DRY principle violations
            - Proper error handling

            ⚡ **Performance**:
            - Inefficient algorithms
            - Memory leaks
            - Unnecessary operations

            📝 **Best Practices**:
            - Adherence to language conventions
            - Proper documentation
            - Test coverage

            Please provide specific, actionable feedback. Point out the exact lines with issues.
            Use markdown formatting for clarity. Be constructive and helpful.

            If the code looks good overall, respond with "LGTM 👍" and highlight any particularly good practices you noticed.

      - name: Extract Review Result
        id: extract
        run: |
          # Read the claude execution output
          if [ -f "/home/runner/work/_temp/claude-execution-output.json" ]; then
            # Extract the result field and save to file
            cat /home/runner/work/_temp/claude-execution-output.json | jq -r '.result' > review_comment.md

            # Check if extraction was successful
            if [ -s review_comment.md ]; then
              echo "Review extracted successfully"
              echo "has_review=true" >> $GITHUB_OUTPUT
            else
              echo "No review content found"
              echo "has_review=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Claude output file not found"
            echo "has_review=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Review as Comment
        if: steps.extract.outputs.has_review == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review_comment.md', 'utf8');

            // Create a comment on the PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## 🤖 AI Code Review by Claude\n\n${reviewContent}`
            });

            console.log('Review comment posted successfully!');