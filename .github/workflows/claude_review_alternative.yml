name: Claude Code Review (Alternative)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff and prepare review
        id: prepare_review
        run: |
          # main ë¸Œëœì¹˜ì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ëœ ë‚´ìš© ì¶”ì¶œ
          git fetch origin main:main
          DIFF_CONTENT=$(git diff main...HEAD | head -c 10000) # 10KBë¡œ ì œí•œ

          # í”„ë¡¬í”„íŠ¸ ì½ê¸°
          if [ -f "prompts/code_review.txt" ]; then
            PROMPT=$(cat prompts/code_review.txt)
          else
            PROMPT="Please review this code change for best practices and potential issues."
          fi

          # Claude API ìš”ì²­ ë³¸ë¬¸ ìƒì„±
          REQUEST_BODY=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg diff "$DIFF_CONTENT" \
            '{
              model: "claude-3-5-sonnet-20241022",
              max_tokens: 2000,
              messages: [
                {
                  role: "user",
                  content: ($prompt + "\n\nCode changes:\n```diff\n" + $diff + "\n```")
                }
              ]
            }')

          echo "$REQUEST_BODY" > request.json

      - name: Call Claude API
        id: claude_api
        run: |
          RESPONSE=$(curl -X POST https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @request.json)

          # ì‘ë‹µì—ì„œ content ì¶”ì¶œ
          REVIEW_CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not get review content"')

          # Base64 ì¸ì½”ë”©í•˜ì—¬ íŠ¹ìˆ˜ë¬¸ì ë¬¸ì œ ë°©ì§€
          ENCODED_REVIEW=$(echo "$REVIEW_CONTENT" | base64 -w 0)
          echo "review_encoded=$ENCODED_REVIEW" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            // Base64 ë””ì½”ë”©
            const encodedReview = '${{ steps.claude_api.outputs.review_encoded }}';
            const review = Buffer.from(encodedReview, 'base64').toString('utf-8');

            // PRì— ì½”ë©˜íŠ¸ ì‘ì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¤– Claude AI Code Review\n\n${review}\n\n---\n*Reviewed by Claude 3.5 Sonnet*`
            });